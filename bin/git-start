#!/bin/bash

# Use to start working on an existing branch.
# The script rebases on the latest master
branch=$1

if [ -z "$branch" ]; then
  echo "Please, specify a branch name."
  echo "Usage: $0 <branch>"
  exit 1
fi

# Stash any changes in the working tree
tree_changes=$(git status -s)
changes_stashed=0

if [ ! -z "$tree_changes" ]; then
  echo "Working tree is not clean."
  echo "Stashing the changes for you."

  git stash save -u "[git-start] Working changes"

  changes_stashed=1
fi

# Bring master up to date
git-master

# Either create or checkout the target branch
branch_exists=$(git branch --list $branch)

if [ -z "$branch_exists" ]; then
  echo "Branch $branch does not exist. Creating it."
  git checkout -b $branch
else
  echo "Branch $branch exists. Rebasing on master."
  git checkout $branch
  git rebase master
fi

# Pop (any) stashed changes
if [ $changes_stashed -eq 1 ]; then
  echo "Popping the stashed changes."

  git stash pop
fi
